(()=>{"use strict";const t={apiKey:"AIzaSyAyPj-i9tN6KR43kMyclNaYY0BgCCZ5gQk",authDomain:"votenow-1d7fb.firebaseapp.com",databaseURL:"https://votenow-1d7fb-default-rtdb.firebaseio.com",projectId:"votenow-1d7fb",storageBucket:"votenow-1d7fb.appspot.com",messagingSenderId:"28139119211",appId:"1:28139119211:web:132c637874e4ad1fcb072e",measurementId:"G-6D6R3J0TJ7"};class e{constructor(){this.timestamp=Date.now(),this.groupId=this.timestamp,firebase.initializeApp(t),this.db=firebase.database(),this.affirmitiveVotes=[],this.localStorageKey="affirmitive"}createGroup(){return localStorage.removeItem(`done-${this.groupId}`),this.db.ref("votegroup/"+this.groupId).set({timestamp:this.timestamp,status:"active",totalIn:0}),this.groupId}closeVote(){this.db.ref("votegroup/"+this.groupId).update({status:"closed"})}incrementTotalIn(){localStorage.setItem(`done-${this.groupId}`,!0);const t=`votegroup/${this.groupId}`;this.db.ref(t).once("value",(e=>{const o=e.val();this.db.ref(t).update({totalIn:o.totalIn+=1})}))}addOption(t){const e=Date.now();this.db.ref("votegroup/"+this.groupId).update({totalIn:0}),this.db.ref("votegroup/"+this.groupId+"/options/"+e).set({option:t,id:e,votes:0})}checkOption(t){let e=JSON.parse(localStorage.getItem("affirmitive"))??[];e.push(t),localStorage.setItem("affirmitive",JSON.stringify(e));const o=`votegroup/${this.groupId}/options/${t}`;this.db.ref(o).once("value",(t=>{const e=t.val();this.db.ref(o).update({votes:e.votes+=1})}))}uncheckOption(t){let e=JSON.parse(localStorage.getItem("affirmitive"))??[];e=e.filter((e=>e!==t.toString())),localStorage.setItem("affirmitive",JSON.stringify(e));const o=`votegroup/${this.groupId}/options/${t}`;this.db.ref(o).once("value",(t=>{const e=t.val();this.db.ref(o).update({votes:e.votes-=1})}))}getGroup(t,e){this.groupId=t,this.db.ref(`votegroup/${t}`).once("value",(o=>{o&&this.db.ref(`votegroup/${t}/options`).on("child_added",e)}))}getVotes(){return JSON.parse(localStorage.getItem("affirmitive"))??[]}subscribeToStatusChanges(t){this.db.ref(`votegroup/${this.groupId}`).on("value",(e=>{const o=e.val();t(o)}))}}window.voteNow=new class{constructor(){this.votingService=new e,this.step1=document.querySelector("[data-step-1]"),this.step2=document.querySelector("[data-step-2]"),this.step3=document.querySelector("[data-step-3]"),this.createGroupButton=document.getElementById("create-group-button"),this.addOptionForm=document.getElementById("add-option"),this.closeGroupButton=document.getElementById("close-group-button"),this.optionsContainer=document.getElementById("options"),this.shareButton=document.getElementById("share-button"),this.doneAction=document.getElementById("done-action"),this.addedAction=document.getElementById("added-action"),this.totalIn=document.getElementById("total-in"),this.doneVoting=!1,this.overlay=document.getElementById("overlay"),this.options=[],this.init()}init(){this.bindButtons(),this.onWindowLoad()}bindButtons(){this.createGroupButton.addEventListener("click",(t=>{const e=this.votingService.createGroup();window.location=`${window.location}?groupId=${e}`})),this.addOptionForm.onsubmit=t=>{t.preventDefault();const e=document.getElementById("option");this.votingService.addOption(e.value),e.value="",this.addedAction.classList.remove("hidden"),this.doneAction.classList.add("hidden")},this.closeGroupButton.addEventListener("click",(t=>{this.votingService.closeVote()})),this.shareButton.addEventListener("click",(t=>{this.share()}));const t=this;this.doneAction.addEventListener("click",(e=>{t.doneAction.classList.add("hidden"),t.votingService.incrementTotalIn(),document.getElementById("done-message").classList.remove("hidden")})),this.addedAction.querySelector("a").addEventListener("click",(t=>{this.shareAdded()}))}onWindowLoad(){window.addEventListener("load",(t=>{let e=new URLSearchParams(window.location.search).get("groupId");e&&(this.step2.classList.remove("hidden"),this.step1.classList.add("hidden"),this.votingService.getGroup(e,(t=>{const e=t.val();this.options.push(e);const o=this.buildOption(e);this.optionsContainer.appendChild(o)})),this.votingService.subscribeToStatusChanges((t=>{const e=Object.values(t?.options??[]).some((t=>t.votes>0));this.totalIn.innerText=t?.totalIn,e?this.closeGroupButton.removeAttribute("disabled"):this.closeGroupButton.setAttribute("disabled",!0),t&&t.status&&"closed"==t.status&&this.onVoteClose(t)})))})),setTimeout((()=>{this.overlay.classList.add("hide")}),1e3)}buildOption(t){const e=this.votingService.getVotes(),o=document.createElement("input");o.type="checkbox",o.checked=e.includes(t.id.toString()),o.id=t.id,o.classList.add("hide"),o.onchange=t=>{this.handleVote(t)};const i=document.createElement("label");i.append(t.option);const s=document.createElement("div");return s.appendChild(o),s.appendChild(i),s}handleVote(t){const e=t.target.checked,o=t.target.id;e?(this.addedAction.classList.add("hidden"),this.doneAction.classList.remove("hidden"),this.votingService.checkOption(o)):this.votingService.uncheckOption(o)}onVoteClose(t){this.step2.classList.add("hidden"),this.step3.classList.remove("hidden");const e=this._shuffle(Object.values(t.options)).reduce(((t,e)=>t.votes>e.votes?t:e)),o=document.createElement("h2");o.classList.add("slide-up"),o.innerText=e.option,document.getElementById("result").appendChild(o)}share(){navigator.share&&navigator.share({title:"Add your vote!",url:window.location.href}).then((()=>{console.log("Thanks for sharing!")})).catch(console.error)}shareAdded(){navigator.share&&navigator.share({title:"New Options",text:"I added options to our Voty!",url:window.location.href}).then((()=>{console.log("Thanks for sharing!")})).catch(console.error)}_shuffle(t){for(let e=t.length-1;e>0;e--){const o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t}}})();