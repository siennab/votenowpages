(()=>{"use strict";const t={apiKey:"AIzaSyAyPj-i9tN6KR43kMyclNaYY0BgCCZ5gQk",authDomain:"votenow-1d7fb.firebaseapp.com",databaseURL:"https://votenow-1d7fb-default-rtdb.firebaseio.com",projectId:"votenow-1d7fb",storageBucket:"votenow-1d7fb.appspot.com",messagingSenderId:"28139119211",appId:"1:28139119211:web:132c637874e4ad1fcb072e",measurementId:"G-6D6R3J0TJ7"};class e{constructor(){this.timestamp=Date.now(),this.groupId=this.timestamp,firebase.initializeApp(t),this.db=firebase.database(),this.affirmitiveVotes=[],this.localStorageKey="affirmitive",this.voted=!1}createGroup(){return localStorage.removeItem(`done-${this.groupId}`),this.db.ref(`votegroup/${this.groupId}`).set({timestamp:this.timestamp,status:"active",totalIn:0}),this.groupId}closeVote(){this.db.ref("votegroup/"+this.groupId).update({status:"closing"})}incrementTotalIn(){if(!localStorage.getItem(`done-${this.groupId}`)){localStorage.setItem(`done-${this.groupId}`,!0);const t=`votegroup/${this.groupId}`;this.db.ref(t).once("value",(e=>{let o=e.val().totalIn??0;this.db.ref(t).update({totalIn:o+=1})}))}}addOption(t){const e=Date.now();return this.db.ref("votegroup/"+this.groupId+"/options/"+e).update({option:t,id:e,votes:0}),{option:t,id:e,votes:0}}checkOption(t){let e=JSON.parse(localStorage.getItem("affirmitive"))??[];e.push(t),localStorage.setItem("affirmitive",JSON.stringify(e));const o=`votegroup/${this.groupId}/options/${t}`;this.db.ref(o).once("value",(t=>{const e=t.val();this.db.ref(o).update({votes:e.votes+=1})})),this.voted||(this.incrementTotalIn(),this.voted=!0)}uncheckOption(t){let e=JSON.parse(localStorage.getItem("affirmitive"))??[];e=e.filter((e=>e!==t.toString())),localStorage.setItem("affirmitive",JSON.stringify(e));const o=`votegroup/${this.groupId}/options/${t}`;this.db.ref(o).once("value",(t=>{const e=t.val();this.db.ref(o).update({votes:e.votes-=1})}))}getGroup(t,e){this.groupId=t,this.db.ref(`votegroup/${t}`).once("value",(o=>{o&&this.db.ref(`votegroup/${t}/options`).on("child_added",e)}))}getVotes(){return JSON.parse(localStorage.getItem("affirmitive"))??[]}subscribeToStatusChanges(t){this.db.ref(`votegroup/${this.groupId}`).on("value",(e=>{const o=e.val();if(o&&o.status&&"closing"==o.status){if(o.winner)return;const t=this._shuffle(Object.values(o.options)).reduce(((t,e)=>t.votes>e.votes?t:e));this.db.ref("votegroup/"+this.groupId).update({status:"closed",winner:t})}t(o)}))}_shuffle(t){for(let e=t.length-1;e>0;e--){const o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t}}window.voteNow=new class{constructor(){this.votingService=new e,this.step1=document.querySelector("[data-step-1]"),this.step2=document.querySelector("[data-step-2]"),this.step3=document.querySelector("[data-step-3]"),this.createGroupButton=document.getElementById("create-group-button"),this.addOptionForm=document.getElementById("add-option"),this.closeGroupButton=document.getElementById("close-group-button"),this.optionsContainer=document.getElementById("options"),this.shareButton=document.getElementById("share-button"),this.shareButtonResults=document.getElementById("share-button-results"),this.doneMessage=document.getElementById("done-message"),this.totalIn=document.getElementById("total-in"),this.overlay=document.getElementById("overlay"),this.options=[],this.init()}init(){this.bindButtons(),this.onWindowLoad()}bindButtons(){this.createGroupButton.addEventListener("click",(t=>{const e=this.votingService.createGroup();window.location=`${window.location}?groupId=${e}`})),this.addOptionForm.onsubmit=t=>{t.preventDefault();const e=document.getElementById("option");var o=this.votingService.addOption(e.value);e.value="",document.getElementById(o.id).click()},this.closeGroupButton.innerText="Choose randomly",this.closeGroupButton.addEventListener("click",(t=>{this.votingService.closeVote()})),this.shareButton.addEventListener("click",(t=>{this.share()})),this.shareButtonResults.addEventListener("click",(t=>{this.share("The winner is...")})),this.doneMessage.classList.remove("hidden")}onWindowLoad(){window.addEventListener("load",(t=>{let e=new URLSearchParams(window.location.search).get("groupId");e&&(localStorage.getItem(`done-${e}`)&&this.doneMessage.classList.remove("hidden"),this.step2.classList.remove("hidden"),this.step1.classList.add("hidden"),this.votingService.getGroup(e,(t=>{const e=t.val();this.options.push(e);const o=this.buildOption(e);this.optionsContainer.appendChild(o)})),this.votingService.subscribeToStatusChanges((t=>{const e=Object.values(t?.options??[]).some((t=>t.votes>0));this.totalIn.innerText=t?.totalIn||0,t?.totalIn>1&&(this.closeGroupButton.innerText="Everyone's in"),e?this.closeGroupButton.removeAttribute("disabled"):this.closeGroupButton.setAttribute("disabled",!0),t&&t.status&&"closed"==t.status&&this.onVoteClose(t)})))})),setTimeout((()=>{this.overlay.classList.add("hide")}),1e3)}buildOption(t){const e=this.votingService.getVotes(),o=document.createElement("input");o.type="checkbox",o.checked=e.includes(t.id.toString()),o.id=t.id,o.classList.add("hide"),o.onchange=t=>{this.handleVote(t)};const s=document.createElement("label");s.append(t.option);const i=document.createElement("div");return i.appendChild(o),i.appendChild(s),i}handleVote(t){const e=t.target.checked,o=t.target.id;e?this.votingService.checkOption(o):this.votingService.uncheckOption(o)}onVoteClose(t){this.step2.classList.add("hidden"),this.step3.classList.remove("hidden");const e=t.winner,o=document.createElement("h2");o.classList.add("slide-up"),o.innerText=e.option,document.getElementById("result-accent").appendChild(o)}share(t="Give your input!"){navigator.share?navigator.share({title:"Voty",text:t,url:window.location.href}).then((()=>{console.log("Thanks for sharing!")})).catch(console.error):navigator.clipboard.writeText(window.location.href).then((()=>{alert("The link to this Voty has been copied to your clipboard. To share what you're seeing, simply paste it to your group.")}))}}})();